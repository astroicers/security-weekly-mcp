name: Monthly Health Check

on:
  schedule:
    # æ¯æœˆ 1 æ—¥æ—©ä¸Š 9:00 (UTC+8 = 01:00 UTC)
    - cron: '0 1 1 * *'
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync

      - name: Check RSS sources availability
        id: rss_check
        run: |
          cat > check_sources.py << 'EOF'
          import asyncio
          import httpx
          import yaml
          from pathlib import Path

          async def check_source(client: httpx.AsyncClient, source: dict) -> dict:
              name = source.get("name", "Unknown")
              url = source.get("url", "")
              source_type = source.get("type", "")
              status = source.get("status", "")

              if status == "disabled" or source_type != "rss" or not url:
                  return {"name": name, "status": "skipped", "url": url}

              try:
                  response = await client.head(url, follow_redirects=True)
                  if response.status_code < 400:
                      return {"name": name, "status": "ok", "code": response.status_code}
                  else:
                      return {"name": name, "status": "error", "code": response.status_code, "url": url}
              except Exception as e:
                  return {"name": name, "status": "error", "error": str(e)[:100], "url": url}

          async def main():
              config_path = Path("config/sources.yaml")
              with open(config_path, "r", encoding="utf-8") as f:
                  config = yaml.safe_load(f)

              sources = config.get("sources", [])

              headers = {
                  "User-Agent": "Mozilla/5.0 (compatible; HealthCheck/1.0)"
              }

              async with httpx.AsyncClient(timeout=15.0, headers=headers) as client:
                  tasks = [check_source(client, s) for s in sources]
                  results = await asyncio.gather(*tasks, return_exceptions=True)

              ok_count = 0
              error_count = 0
              skipped_count = 0
              errors = []

              for r in results:
                  if isinstance(r, Exception):
                      error_count += 1
                      continue
                  if r["status"] == "ok":
                      ok_count += 1
                  elif r["status"] == "error":
                      error_count += 1
                      errors.append(r)
                  else:
                      skipped_count += 1

              total = ok_count + error_count
              rate = (ok_count / total * 100) if total > 0 else 0

              print(f"ok_count={ok_count}")
              print(f"error_count={error_count}")
              print(f"skipped_count={skipped_count}")
              print(f"availability_rate={rate:.1f}")

              if errors:
                  print("errors_detail=")
                  for e in errors:
                      print(f"  - {e['name']}: {e.get('error', 'HTTP ' + str(e.get('code', '?')))}")

          asyncio.run(main())
          EOF

          uv run python check_sources.py > health_output.txt 2>&1
          cat health_output.txt

          # Parse output
          ok=$(grep "ok_count=" health_output.txt | cut -d= -f2)
          errors=$(grep "error_count=" health_output.txt | cut -d= -f2)
          rate=$(grep "availability_rate=" health_output.txt | cut -d= -f2)

          echo "ok_count=$ok" >> $GITHUB_OUTPUT
          echo "error_count=$errors" >> $GITHUB_OUTPUT
          echo "availability_rate=$rate" >> $GITHUB_OUTPUT

      - name: Check for dependency updates
        id: dep_check
        run: |
          # Check for outdated packages
          uv pip list --outdated > outdated.txt 2>&1 || true
          outdated_count=$(wc -l < outdated.txt)
          echo "outdated_count=$outdated_count" >> $GITHUB_OUTPUT

      - name: Run security audit
        id: security_audit
        continue-on-error: true
        run: |
          uv pip install pip-audit
          uv run pip-audit --format json > audit.json 2>&1 || true
          vuln_count=$(jq 'length' audit.json 2>/dev/null || echo "0")
          echo "vulnerability_count=$vuln_count" >> $GITHUB_OUTPUT

      - name: Create health report issue
        uses: actions/github-script@v7
        with:
          script: |
            const okCount = parseInt('${{ steps.rss_check.outputs.ok_count }}') || 0;
            const errorCount = parseInt('${{ steps.rss_check.outputs.error_count }}') || 0;
            const rate = '${{ steps.rss_check.outputs.availability_rate }}' || '0';
            const outdatedCount = parseInt('${{ steps.dep_check.outputs.outdated_count }}') || 0;
            const vulnCount = parseInt('${{ steps.security_audit.outputs.vulnerability_count }}') || 0;

            const healthEmoji = parseFloat(rate) >= 90 ? 'ğŸŸ¢' : parseFloat(rate) >= 70 ? 'ğŸŸ¡' : 'ğŸ”´';
            const securityEmoji = vulnCount === 0 ? 'ğŸŸ¢' : 'ğŸ”´';

            const now = new Date();
            const month = now.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long' });

            const body = `## ğŸ“Š ${month} å¥åº·æª¢æŸ¥å ±å‘Š

            ### RSS ä¾†æºç‹€æ…‹
            ${healthEmoji} **å¯ç”¨ç‡**: ${rate}%
            - âœ… æ­£å¸¸: ${okCount} å€‹
            - âŒ ç•°å¸¸: ${errorCount} å€‹

            ### ä¾è³´ç‹€æ…‹
            - ğŸ“¦ å¯æ›´æ–°å¥—ä»¶: ${outdatedCount} å€‹
            ${securityEmoji} **å®‰å…¨æ¼æ´**: ${vulnCount} å€‹

            ### å»ºè­°å‹•ä½œ
            ${errorCount > 0 ? '- âš ï¸ æª¢æŸ¥å¤±æ•—çš„ RSS ä¾†æºï¼Œè€ƒæ…®åœç”¨æˆ–æ›´æ–° URL' : '- âœ… æ‰€æœ‰ RSS ä¾†æºæ­£å¸¸'}
            ${vulnCount > 0 ? '- ğŸ”’ åŸ·è¡Œ `uv pip install --upgrade` ä¿®å¾©å®‰å…¨æ¼æ´' : '- âœ… ç„¡å·²çŸ¥å®‰å…¨æ¼æ´'}
            ${outdatedCount > 5 ? '- ğŸ“¦ è€ƒæ…®æ›´æ–°éæ™‚çš„ä¾è³´å¥—ä»¶' : ''}

            ---
            ğŸ¤– æ­¤å ±å‘Šç”± GitHub Actions è‡ªå‹•ç”¢ç”Ÿ
            ğŸ“… æª¢æŸ¥æ™‚é–“: ${now.toISOString()}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“Š ${month} å¥åº·æª¢æŸ¥å ±å‘Š`,
              body: body,
              labels: ['health-check', 'monthly']
            });

            console.log('Created health check issue');
