name: Weekly Project Reminder

on:
  schedule:
    # æ¯é€±äº”æ—©ä¸Š 9:00 (UTC+8 = é€±äº” 01:00 UTC)
    - cron: '0 1 * * 5'
  workflow_dispatch:

jobs:
  remind:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Check pending terms
        id: check
        run: |
          pending_dir="packages/glossary/terms/pending"
          if [ -d "$pending_dir" ]; then
            count=$(find "$pending_dir" -name "*.yaml" 2>/dev/null | wc -l)
          else
            count=0
          fi
          echo "pending_count=$count" >> $GITHUB_OUTPUT
          echo "Found $count pending terms"

      - name: Check recent workflow runs
        id: workflows
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # å–å¾—æœ€è¿‘çš„é€±å ±ç”¢ç”Ÿçµæœ
          result=$(gh run list --workflow=weekly-report.yml --limit=1 --json conclusion,createdAt -q '.[0]')
          conclusion=$(echo "$result" | jq -r '.conclusion // "unknown"')
          created=$(echo "$result" | jq -r '.createdAt // "unknown"')
          echo "last_report_status=$conclusion" >> $GITHUB_OUTPUT
          echo "last_report_date=$created" >> $GITHUB_OUTPUT

      - name: Create reminder issue
        uses: actions/github-script@v7
        with:
          script: |
            const pendingCount = parseInt('${{ steps.check.outputs.pending_count }}') || 0;
            const lastStatus = '${{ steps.workflows.outputs.last_report_status }}';
            const lastDate = '${{ steps.workflows.outputs.last_report_date }}';

            const statusEmoji = lastStatus === 'success' ? 'âœ…' : 'âš ï¸';
            const formattedDate = lastDate !== 'unknown'
              ? new Date(lastDate).toLocaleDateString('zh-TW', {
                  year: 'numeric', month: 'long', day: 'numeric'
                })
              : 'æœªçŸ¥';

            const body = `## ğŸ“… æœ¬é€±è³‡å®‰é€±å ±æé†’

### é€±å ±ç‹€æ…‹
- ${statusEmoji} æœ€è¿‘ä¸€æ¬¡é€±å ±ç”¢ç”Ÿï¼š**${lastStatus}**
- ğŸ“† ç”¢ç”Ÿæ™‚é–“ï¼š${formattedDate}
- ğŸ“¥ [æŸ¥çœ‹é€±å ± Artifacts](../../actions/workflows/weekly-report.yml)

### å¾…è™•ç†äº‹é …
- ğŸ“ å¾…å¯©è¡“èªï¼š**${pendingCount}** å€‹
${pendingCount > 0 ? '- â³ è«‹ä½¿ç”¨ Claude Code çš„ security-weekly-tw skill å¯©æ ¸å¾…å¯©è¡“èª' : '- âœ¨ ç›®å‰æ²’æœ‰å¾…å¯©è¡“èª'}

### å¿«é€Ÿæ“ä½œ
- æ‰‹å‹•ç”¢ç”Ÿé€±å ±ï¼š[è§¸ç™¼ Weekly Report Workflow](../../actions/workflows/weekly-report.yml)
- æŸ¥çœ‹è³‡å®‰ä¾†æºè¨­å®šï¼š[sources.yaml](../../blob/main/config/sources.yaml)

---
ğŸ¤– æ­¤ Issue ç”± GitHub Actions è‡ªå‹•å»ºç«‹`;

            const title = `ğŸ“… é€±å ±æé†’ - ${new Date().toLocaleDateString('zh-TW', { month: 'long', day: 'numeric' })}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['reminder', 'weekly-report']
            });

            console.log('Created reminder issue:', title);
